{% extends "base.html" %}

{% block content %}
<div class="container py-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Tableau de bord</a></li>
            <li class="breadcrumb-item active" aria-current="page">Trade #{{ trade.id }}</li>
        </ol>
    </nav>

    <!-- Section Trades Disponibles avec scroll horizontal -->
    {% if available_trades %}
    <div class="card shadow-sm mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Trades Disponibles</h5>
            <small class="text-muted">{{ available_trades|length }} trades</small>
        </div>
        <div class="card-body p-0">
            <div class="horizontal-scroll-wrapper">
                <div class="horizontal-scroll-container">
                    {% for t in available_trades %}
                    <!-- CORRECTION ICI : Utilisez 'view_trade' au lieu de 'trade' -->
                    <a href="{{ url_for('view_trade', trade_id=t.id) }}" 
                       class="trade-card {% if t.id == trade.id %}active{% endif %}">
                        <div class="trade-card-content">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <span class="badge {% if t.result == 'win' %}bg-success{% else %}bg-danger{% endif %}">
                                    {{ t.result|upper }}
                                </span>
                                <small class="text-muted">#{{ t.id }}</small>
                            </div>
                            <h6 class="mb-1">{{ t.symbol }}</h6>
                            <div class="trade-info">
                                <small class="d-block text-muted">
                                    {{ t.date.strftime('%d/%m') }}
                                </small>
                                <span class="fw-bold {% if t.pnl > 0 %}text-success{% else %}text-danger{% endif %}">
                                    {{ "%.2f"|format(t.pnl) }}$
                                </span>
                            </div>
                        </div>
                    </a>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Résumé rapide du trade -->
    <div class="card mb-4 shadow-sm">
        <div class="card-body d-flex justify-content-between align-items-center flex-wrap">
            <div>
                {% if trade.result == 'win' %}
                    <span class="badge bg-success px-3 py-2"><i class="fas fa-check me-1"></i>WIN</span>
                {% else %}
                    <span class="badge bg-danger px-3 py-2"><i class="fas fa-times me-1"></i>LOSS</span>
                {% endif %}
                <h4 class="mt-3 mb-0">{{ trade.symbol }}</h4>
            </div>
            <a href="{{ url_for('edit_trade', trade_id=trade.id) }}" class="btn btn-primary mt-2">
                <i class="fas fa-edit me-1"></i> Modifier
            </a>
        </div>

        <div class="row g-3 mt-3 text-center text-md-start">
            <!-- PnL -->
            <div class="col-md-3 col-6">
                <small class="text-muted fw-semibold">PnL</small>
                <h6 class="fw-bold {% if trade.pnl > 0 %}text-success{% else %}text-danger{% endif %} mt-1">
                    {{ "%.2f"|format(trade.pnl) }} $
                </h6>
            </div>

            <!-- Lot Size -->
            <div class="col-md-3 col-6">
                <small class="text-muted fw-semibold">Lot Size</small>
                <h6 class="fw-semibold mt-1">{{ trade.lot }}</h6>
            </div>

            <!-- Prix d'entrée -->
            <div class="col-md-3 col-6">
                <small class="text-muted fw-semibold">Prix d'entrée</small>
                <h6 class="fw-semibold mt-1">
                    {{ "%.5f"|format(trade.entry) }}
                </h6>
            </div>

            <!-- Prix de sortie -->
            <div class="col-md-3 col-6">
                <small class="text-muted fw-semibold">Prix de sortie</small>
                <h6 class="fw-semibold mt-1">
                    {{ "%.5f"|format(trade.exit) }}
                </h6>
            </div>
        </div>
    </div>

    <!-- Détails du trade -->
    <div class="card shadow-sm mb-4">
        <div class="card-header">
            <h5 class="mb-0">Détails du trade</h5>
        </div>
        <div class="card-body">
            <div class="row g-4">
                <div class="col-md-6">
                    <p><strong>Date & heure :</strong> {{ trade.date.strftime('%d/%m/%Y à %H:%M') }}</p>

                    {% if trade.risk %}
                    <p><strong>Risque :</strong> {{ "%.2f"|format(trade.risk) }} $</p>
                    {% endif %}

                    {% if trade.risk_reward %}
                    <p><strong>Risk/Reward :</strong> {{ "%.2f"|format(trade.risk_reward) }}:1</p>
                    {% endif %}

                    {% if trade.position_count and trade.position_count > 1 %}
                    <p><strong>Positions Multiples :</strong> {{ trade.position_count }} positions</p>
                    {% endif %}
                </div>

                <!-- Graphique responsive avec zoom et modal fullscreen -->
                <div class="col-md-6 text-center">
                    {% if trade.graph_link %}
                    <img src="{{ trade.graph_link }}"
                         alt="Graphique d'analyse"
                         class="img-fluid w-100 rounded shadow-sm mb-3 graph-zoom"
                         style="max-height: 400px; object-fit: contain; cursor: pointer;"
                         data-bs-toggle="modal" data-bs-target="#graphModal">
                    {% endif %}
                </div>

                <!-- Commentaire -->
                {% if trade.comment %}
                <div class="col-12">
                    <div class="p-3 rounded border">
                        <h6 class="mb-2"><i class="fas fa-comment-dots me-2"></i>Commentaire :</h6>
                        <div>
                            {{ trade.comment | replace('\n', '<br>') | safe }}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modal fullscreen pour le graphique -->
<div class="modal fade" id="graphModal" tabindex="-1" aria-labelledby="graphModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="graphModalLabel">{{ trade.symbol }} - Graphique</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body text-center">
        <img src="{{ trade.graph_link }}" alt="Graphique plein écran" class="img-fluid rounded shadow-sm" style="max-height: 80vh; object-fit: contain;">
      </div>
    </div>
  </div>
</div>

<!-- Styles pour l'effet de zoom et le scroll horizontal -->
<style>
.dark-mode small {
    color: #cccccc !important;
}
.dark-mode h6 {
    color: #ffffff !important;
}
.graph-zoom {
    transition: transform 0.3s ease;
}
.graph-zoom:hover {
    transform: scale(1.03);
}

/* Styles pour le scroll horizontal des trades */
.horizontal-scroll-wrapper {
    overflow-x: auto;
    overflow-y: hidden;
    padding: 1rem;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: thin;
}

.horizontal-scroll-container {
    display: flex;
    gap: 1rem;
    min-width: min-content;
    padding-bottom: 0.5rem;
}

.trade-card {
    display: block;
    min-width: 200px;
    max-width: 200px;
    border: 2px solid #dee2e6;
    border-radius: 10px;
    padding: 1rem;
    text-decoration: none;
    color: inherit;
    transition: all 0.2s ease;
    background: white;
    flex-shrink: 0;
}

.trade-card:hover {
    border-color: #0d6efd;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    text-decoration: none;
}

.trade-card.active {
    border-color: #0d6efd;
    background-color: #f8f9fa;
}

.trade-card-content {
    height: 100%;
}

.trade-info {
    margin-top: 0.5rem;
}

/* Styles pour le dark mode */
.dark-mode .trade-card {
    background: #2d3748;
    border-color: #4a5568;
    color: #e2e8f0;
}

.dark-mode .trade-card.active {
    background-color: #4a5568;
    border-color: #63b3ed;
}

.dark-mode .trade-card:hover {
    border-color: #63b3ed;
    background-color: #374151;
}

/* Custom scrollbar */
.horizontal-scroll-wrapper::-webkit-scrollbar {
    height: 8px;
}

.horizontal-scroll-wrapper::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

.horizontal-scroll-wrapper::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
}

.horizontal-scroll-wrapper::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

.dark-mode .horizontal-scroll-wrapper::-webkit-scrollbar-track {
    background: #2d3748;
}

.dark-mode .horizontal-scroll-wrapper::-webkit-scrollbar-thumb {
    background: #4a5568;
}

.dark-mode .horizontal-scroll-wrapper::-webkit-scrollbar-thumb:hover {
    background: #718096;
}
</style>
{% endblock %}
